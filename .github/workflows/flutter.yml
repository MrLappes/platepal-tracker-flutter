name: Flutter CI

on:
  push:
    branches: [ "main" ]
    tags:     [ "v*" ]   # <-- pushing a tag like v1.0.0 will build + release
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write   # required to create a GitHub Release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-and-maybe-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Flutter doctor
        run: |
          flutter --version
          flutter doctor -v

      - name: Cache Flutter/Dart artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
            build
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Test (with coverage)
        run: flutter test --coverage

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: coverage/lcov.info
          if-no-files-found: warn

      # ---------- Build only for tag pushes (i.e., releases) ----------
      - name: Accept Android SDK licenses
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          echo "Accepting Android SDK licenses (best effort)..."
          if [[ -n "${ANDROID_SDK_ROOT}" && -x "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" ]]; then
            yes | "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --licenses || true
          elif [[ -x "/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager" ]]; then
            yes | /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          else
            echo "sdkmanager not found; skipping."
          fi

      - name: Build APK (release)
        if: startsWith(github.ref, 'refs/tags/')
        run: flutter build apk --release

      - name: Build AAB (release)
        if: startsWith(github.ref, 'refs/tags/')
        run: flutter build appbundle --release

      - name: Upload release artifacts (CI archive)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: release-builds-${{ github.ref_name }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
            # web-release.zip
          if-no-files-found: error

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
            # web-release.zip
            coverage/lcov.info
